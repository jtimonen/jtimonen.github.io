<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.557">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Juho Timonen">
<meta name="dcterms.date" content="2021-11-29">
<meta name="keywords" content="Stan, C++">
<meta name="description" content="Overview of the different libraries related to Stan and their organization, and finding and entry point to the internal C++ code.">

<title>Juho Timonen - Understanding the Stan codebase - Part 1: Finding an entry point</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../images/icon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Juho Timonen</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> <i class="bi bi-house" role="img">
</i> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> <i class="bi bi-bookmark" role="img">
</i> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publications.html"> <i class="bi bi-book" role="img">
</i> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../software.html"> <i class="bi bi-body-text" role="img">
</i> 
<span class="menu-text">Software</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#starting-point-cmdstanr" id="toc-starting-point-cmdstanr" class="nav-link" data-scroll-target="#starting-point-cmdstanr"><span class="header-section-number">2</span> Starting point (CmdStanR)</a>
  <ul class="collapse">
  <li><a href="#creating-the-executable" id="toc-creating-the-executable" class="nav-link" data-scroll-target="#creating-the-executable"><span class="header-section-number">2.1</span> Creating the executable</a></li>
  <li><a href="#running-the-executable" id="toc-running-the-executable" class="nav-link" data-scroll-target="#running-the-executable"><span class="header-section-number">2.2</span> Running the executable</a></li>
  </ul></li>
  <li><a href="#cmdstan" id="toc-cmdstan" class="nav-link" data-scroll-target="#cmdstan"><span class="header-section-number">3</span> CmdStan</a>
  <ul class="collapse">
  <li><a href="#main.cpp" id="toc-main.cpp" class="nav-link" data-scroll-target="#main.cpp"><span class="header-section-number">3.1</span> main.cpp</a></li>
  <li><a href="#command.hpp" id="toc-command.hpp" class="nav-link" data-scroll-target="#command.hpp"><span class="header-section-number">3.2</span> command.hpp</a></li>
  </ul></li>
  <li><a href="#stan" id="toc-stan" class="nav-link" data-scroll-target="#stan"><span class="header-section-number">4</span> Stan</a>
  <ul class="collapse">
  <li><a href="#hmc_nuts_diag_e_adapt.hpp" id="toc-hmc_nuts_diag_e_adapt.hpp" class="nav-link" data-scroll-target="#hmc_nuts_diag_e_adapt.hpp"><span class="header-section-number">4.1</span> hmc_nuts_diag_e_adapt.hpp</a></li>
  <li><a href="#run_adaptive_sampler.hpp" id="toc-run_adaptive_sampler.hpp" class="nav-link" data-scroll-target="#run_adaptive_sampler.hpp"><span class="header-section-number">4.2</span> run_adaptive_sampler.hpp</a></li>
  </ul></li>
  <li><a href="#resources" id="toc-resources" class="nav-link" data-scroll-target="#resources"><span class="header-section-number">5</span> Resources</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Understanding the Stan codebase - Part 1: Finding an entry point</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Stan, C++</div>
  </div>
  </div>

<div>
  <div class="description">
    Overview of the different libraries related to Stan and their organization, and finding and entry point to the internal C++ code.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Juho Timonen </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 29, 2021</p>
    </div>
  </div>
  
    
  </div>
  

<div>
  <div class="keywords">
    <div class="block-title">Keywords</div>
    <p>Stan, C++</p>
  </div>
</div>

</header>


<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>So, you have your <a href="https://mc-stan.org/">Stan</a> model written and are doing inference for it, but something weird is happening? Or maybe you want to extend Stan but don’t know where to start because the source code repositories look daunting. These are some of the possible reasons why someone might want to study the internals of Stan, and what is happening under the hood. I have for various reasons for a long time wanted to just see what is happening line-by-line. In this post, I am going to look at how a typical program execution starts to travel through all the different libraries related to Stan, using CmdStanR as the starting point.</p>
<p><img src="stan-structure.png" alt="Stan Organization" width="560"></p>
<p>Relationships between different libraries and various interfaces related to Stan are visualized in the above diagram. The C++ core that we study in this post is organized into three parts.</p>
<ul>
<li><a href="https://github.com/stan-dev/cmdstan">CmdStan</a>: A command-line interface to Stan</li>
<li><a href="https://github.com/stan-dev/stan">Stan</a>: The MCMC and optimization algorithms</li>
<li><a href="https://github.com/stan-dev/math">Stan Math</a>: Mathematical functions and their gradients (automatic differentiation)</li>
</ul>
<p>Many higher-level interfaces, like <a href="https://mc-stan.org/cmdstanr/">CmdStanR</a> and <a href="https://github.com/stan-dev/cmdstanpy">CmdStanPy</a>, call CmdStan internally. <a href="https://mc-stan.org/users/interfaces/rstan">RStan</a> and <a href="https://pystan.readthedocs.io/en/latest/">PyStan</a> employ different strategies that do not rely on CmdStan. A benefit of CmdStan is that it is always released simultaneously with Stan with the same version number, which means that CmdStan is always up to date. In this, post we study the most recent Stan version 2.28.2, and if the source code structure doesn’t experience dramatic changes in the near future, this post might stay relevant for future versions too.</p>
</section>
<section id="starting-point-cmdstanr" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Starting point (CmdStanR)</h1>
<p>In the very beginning, we have nothing but our Stan code, in a file called <strong>mymodel.stan</strong>. For simplicity, we assume that it doesn’t have a data block, but otherwise we are not interested in what the model actually is like. We investigate what happens when we run the following R code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="at">stan_file =</span> <span class="st">"mymodel.stan"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> model<span class="sc">$</span><span class="fu">sample</span>(<span class="at">adapt_delta =</span> <span class="fl">0.95</span>, <span class="at">refresh =</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="creating-the-executable" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="creating-the-executable"><span class="header-section-number">2.1</span> Creating the executable</h2>
<p>The first thing we look at is <code>cmdstan_model(stan_file = "mymodel.stan")</code>. This does two interesting things.</p>
<ul>
<li>Transpiles the Stan model to C++ code using <a href="https://github.com/stan-dev/stanc3">stanc3</a></li>
<li>Compiles the C++ code into an executable file <strong>mymodel.exe</strong> (without the <strong>.exe</strong> file suffix on Mac or Linux).</li>
</ul>
<p>We could have used <code>model$save_hpp_file()</code> to save the model C++ code into <strong>mymodel.hpp</strong> if we wanted to look at that. However, we are now interested in the C++ code that doesn’t depend on the model. I would imagine that also a lot of this model-independent code has to go into the executable.</p>
</section>
<section id="running-the-executable" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="running-the-executable"><span class="header-section-number">2.2</span> Running the executable</h2>
<p>The call <code>model$sample(adapt_delta = 0.95, refresh = 100)</code> <a href="https://github.com/stan-dev/cmdstanr/blob/master/R/run.R">creates four processes</a> (because the default number of chains is four) that each run the executable. For example, the first process creates the command-line call</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mymodel.exe</span> id=1 random seed=660816326 output file=<span class="op">&lt;</span>opath<span class="op">&gt;</span>.csv refresh=100 profile_file=<span class="op">&lt;</span>ppath<span class="op">&gt;</span>.csv method=sample save_warmup=0 algorithm=hmc engine=nuts adapt delta=0.95 engaged=1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where <code>&lt;opath&gt;</code> and <code>&lt;ppath&gt;</code> are paths to some temporary CSV files on the computer. Arguments <code>delta=0.95</code> and <code>refresh=100</code> are things that we specified and others are defaults created by CmdStanR. You can find explanations for the command-line arguments in the <a href="https://mc-stan.org/docs/2_28/cmdstan-guide/command-line-interface-overview.html">CmdStan User’s Guide</a>.</p>
<p>For other processes the <code>id</code> argument is 2, 3, and 4. From now on we study only one chain (the one with <code>id=1</code>) and next try to find the entry point in the CmdStan code that is started with the above command-line instruction.</p>
</section>
</section>
<section id="cmdstan" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> CmdStan</h1>
<p>Inside the <strong>cmdstan</strong> source code repository, we go to <strong>cmdstan/src/cmdstan</strong>.</p>
<section id="main.cpp" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="main.cpp"><span class="header-section-number">3.1</span> main.cpp</h2>
<p>We find a <a href="https://github.com/stan-dev/cmdstan/blob/develop/src/cmdstan/main.cpp">main.cpp</a>, which looks promising. It actually includes an</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="at">const</span> <span class="dt">char</span> <span class="op">*</span>argv<span class="op">[])</span> <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>function which is the starting point of any C++ program. Based on our command line arguments, at this point <code>argc</code> (number of command line arguments) should be 15, <code>argv[0]</code> should be <code>"mymodel.exe"</code>, <code>argv[1]</code> should be <code>"id=1"</code> and so on. We see that <code>main</code> just calls <code>cmdstan::command(argc, argv)</code>, which is defined in <a href="https://github.com/stan-dev/cmdstan/blob/develop/src/cmdstan/command.hpp">command.hpp</a>.</p>
</section>
<section id="command.hpp" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="command.hpp"><span class="header-section-number">3.2</span> command.hpp</h2>
<p>Inside the <code>command()</code> function is a huge if-else parade which is quite difficult to read. So here is a high-level summary of the control flow inside it.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> command<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="at">const</span> <span class="dt">char</span> <span class="op">*</span>argv<span class="op">[])</span> <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ... parse the arguments</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ... initialize model</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ... initialize writers</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>user_method<span class="op">-&gt;</span>arg<span class="op">(</span><span class="st">"generate_quantities"</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>user_method<span class="op">-&gt;</span>arg<span class="op">(</span><span class="st">"diagnose"</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>user_method<span class="op">-&gt;</span>arg<span class="op">(</span><span class="st">"optimize"</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>user_method<span class="op">-&gt;</span>arg<span class="op">(</span><span class="st">"sample"</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>model<span class="op">.</span>num_params_r<span class="op">()</span> <span class="op">==</span> <span class="dv">0</span> <span class="op">||</span> algo<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"fixed_param"</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>      <span class="co">// ...</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>algo<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"hmc"</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>      <span class="co">// ...</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>adapt_engaged <span class="op">==</span> <span class="kw">true</span> <span class="op">&amp;&amp;</span> num_warmup <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ... error</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>engine<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"nuts"</span> <span class="op">&amp;&amp;</span> metric<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"dense_e"</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>                 <span class="op">&amp;&amp;</span> adapt_engaged <span class="op">==</span> <span class="kw">false</span> <span class="op">&amp;&amp;</span> metric_supplied <span class="op">==</span> <span class="kw">false</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ... </span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>engine<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"nuts"</span> <span class="op">&amp;&amp;</span> metric<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"dense_e"</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>                 <span class="op">&amp;&amp;</span> adapt_engaged <span class="op">==</span> <span class="kw">false</span> <span class="op">&amp;&amp;</span> metric_supplied <span class="op">==</span> <span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>engine<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"nuts"</span> <span class="op">&amp;&amp;</span> metric<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"dense_e"</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>                 <span class="op">&amp;&amp;</span> adapt_engaged <span class="op">==</span> <span class="kw">true</span> <span class="op">&amp;&amp;</span> metric_supplied <span class="op">==</span> <span class="kw">false</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>engine<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"nuts"</span> <span class="op">&amp;&amp;</span> metric<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"dense_e"</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>                 <span class="op">&amp;&amp;</span> adapt_engaged <span class="op">==</span> <span class="kw">true</span> <span class="op">&amp;&amp;</span> metric_supplied <span class="op">==</span> <span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>engine<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"nuts"</span> <span class="op">&amp;&amp;</span> metric<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"diag_e"</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>                 <span class="op">&amp;&amp;</span> adapt_engaged <span class="op">==</span> <span class="kw">false</span> <span class="op">&amp;&amp;</span> metric_supplied <span class="op">==</span> <span class="kw">false</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>engine<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"nuts"</span> <span class="op">&amp;&amp;</span> metric<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"diag_e"</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>                 <span class="op">&amp;&amp;</span> adapt_engaged <span class="op">==</span> <span class="kw">false</span> <span class="op">&amp;&amp;</span> metric_supplied <span class="op">==</span> <span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>engine<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"nuts"</span> <span class="op">&amp;&amp;</span> metric<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"diag_e"</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>                 <span class="op">&amp;&amp;</span> adapt_engaged <span class="op">==</span> <span class="kw">true</span> <span class="op">&amp;&amp;</span> metric_supplied <span class="op">==</span> <span class="kw">false</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ... WE </span><span class="re">END</span><span class="co"> UP HERE</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>        return_code <span class="op">=</span> stan<span class="op">::</span>services<span class="op">::</span>sample<span class="op">::</span>hmc_nuts_diag_e_adapt<span class="op">(</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>            model<span class="op">,</span> num_chains<span class="op">,</span> init_contexts<span class="op">,</span> random_seed<span class="op">,</span> id<span class="op">,</span> init_radius<span class="op">,</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>            num_warmup<span class="op">,</span> num_samples<span class="op">,</span> num_thin<span class="op">,</span> save_warmup<span class="op">,</span> refresh<span class="op">,</span> stepsize<span class="op">,</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>            stepsize_jitter<span class="op">,</span> max_depth<span class="op">,</span> delta<span class="op">,</span> gamma<span class="op">,</span> kappa<span class="op">,</span> t0<span class="op">,</span> init_buffer<span class="op">,</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>            term_buffer<span class="op">,</span> window<span class="op">,</span> interrupt<span class="op">,</span> logger<span class="op">,</span> init_writers<span class="op">,</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>            sample_writers<span class="op">,</span> diagnostic_writers<span class="op">);</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>engine<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"nuts"</span> <span class="op">&amp;&amp;</span> metric<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"diag_e"</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>                 <span class="op">&amp;&amp;</span> adapt_engaged <span class="op">==</span> <span class="kw">true</span> <span class="op">&amp;&amp;</span> metric_supplied <span class="op">==</span> <span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>engine<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"nuts"</span> <span class="op">&amp;&amp;</span> metric<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"unit_e"</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>                 <span class="op">&amp;&amp;</span> adapt_engaged <span class="op">==</span> <span class="kw">false</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>engine<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"nuts"</span> <span class="op">&amp;&amp;</span> metric<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"unit_e"</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>                 <span class="op">&amp;&amp;</span> adapt_engaged <span class="op">==</span> <span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>engine<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"static"</span> <span class="op">&amp;&amp;</span> metric<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"dense_e"</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>                 <span class="op">&amp;&amp;</span> adapt_engaged <span class="op">==</span> <span class="kw">false</span> <span class="op">&amp;&amp;</span> metric_supplied <span class="op">==</span> <span class="kw">false</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>engine<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"static"</span> <span class="op">&amp;&amp;</span> metric<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"dense_e"</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>                 <span class="op">&amp;&amp;</span> adapt_engaged <span class="op">==</span> <span class="kw">false</span> <span class="op">&amp;&amp;</span> metric_supplied <span class="op">==</span> <span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>engine<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"static"</span> <span class="op">&amp;&amp;</span> metric<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"dense_e"</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>                 <span class="op">&amp;&amp;</span> adapt_engaged <span class="op">==</span> <span class="kw">true</span> <span class="op">&amp;&amp;</span> metric_supplied <span class="op">==</span> <span class="kw">false</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>engine<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"static"</span> <span class="op">&amp;&amp;</span> metric<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"dense_e"</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>                 <span class="op">&amp;&amp;</span> adapt_engaged <span class="op">==</span> <span class="kw">true</span> <span class="op">&amp;&amp;</span> metric_supplied <span class="op">==</span> <span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>engine<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"static"</span> <span class="op">&amp;&amp;</span> metric<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"diag_e"</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>                 <span class="op">&amp;&amp;</span> adapt_engaged <span class="op">==</span> <span class="kw">false</span> <span class="op">&amp;&amp;</span> metric_supplied <span class="op">==</span> <span class="kw">false</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>engine<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"static"</span> <span class="op">&amp;&amp;</span> metric<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"diag_e"</span></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>                 <span class="op">&amp;&amp;</span> adapt_engaged <span class="op">==</span> <span class="kw">false</span> <span class="op">&amp;&amp;</span> metric_supplied <span class="op">==</span> <span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>engine<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"static"</span> <span class="op">&amp;&amp;</span> metric<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"diag_e"</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>                 <span class="op">&amp;&amp;</span> adapt_engaged <span class="op">==</span> <span class="kw">true</span> <span class="op">&amp;&amp;</span> metric_supplied <span class="op">==</span> <span class="kw">false</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>engine<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"static"</span> <span class="op">&amp;&amp;</span> metric<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"diag_e"</span></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>                 <span class="op">&amp;&amp;</span> adapt_engaged <span class="op">==</span> <span class="kw">true</span> <span class="op">&amp;&amp;</span> metric_supplied <span class="op">==</span> <span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>engine<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"static"</span> <span class="op">&amp;&amp;</span> metric<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"unit_e"</span></span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>                 <span class="op">&amp;&amp;</span> adapt_engaged <span class="op">==</span> <span class="kw">false</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>engine<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"static"</span> <span class="op">&amp;&amp;</span> metric<span class="op">-&gt;</span>value<span class="op">()</span> <span class="op">==</span> <span class="st">"unit_e"</span></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>                 <span class="op">&amp;&amp;</span> adapt_engaged <span class="op">==</span> <span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>user_method<span class="op">-&gt;</span>arg<span class="op">(</span><span class="st">"variational"</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> return_code<span class="op">;</span></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In most of the branches, the left-out part <code>// ...</code> ends up calling something from <code>stan::services</code>. This is also the case in our example, and because our <code>method</code> argument is <code>sample</code>,the default algorithm is NUTS with adaptation engaged and the default metric is diagonal (and we haven’t supplied the metric), we will call <code>stan::services::sample::hmc_nuts_diag_e_adapt()</code>. We will therefore now jump from CmdStan to Stan. Hooray!</p>
</section>
</section>
<section id="stan" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Stan</h1>
<p>Inside the <strong>stan</strong> source code repository, we go to <strong>stan/src/stan</strong>.</p>
<section id="hmc_nuts_diag_e_adapt.hpp" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="hmc_nuts_diag_e_adapt.hpp"><span class="header-section-number">4.1</span> hmc_nuts_diag_e_adapt.hpp</h2>
<p>In <strong>services/sample</strong> we find <a href="https://github.com/stan-dev/stan/blob/develop/src/stan/services/sample/hmc_nuts_diag_e_adapt.hpp">hmc_nuts_diag_e_adapt.hpp</a> which contains the function that we called from CmdStan. But wait, it is actually overloaded with four different versions of it with the same name. Not to mention each of these are templated. We will not stop here to think much about why these all versions of <code>hmc_nuts_diag_e_adapt()</code> are needed. A very valid print debugging approach reveals that in our case, we call the fourth one, which calls the second one, which then calls the first one. There we have</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> cont_vector <span class="op">=</span> util<span class="op">::</span>initialize<span class="op">(</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>      model<span class="op">,</span> init<span class="op">,</span> rng<span class="op">,</span> init_radius<span class="op">,</span> <span class="kw">true</span><span class="op">,</span> logger<span class="op">,</span> init_writer<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>where the parameter values are initialized. In <code>initialize()</code>, which is defined in <a href="https://github.com/stan-dev/stan/blob/develop/src/stan/services/util/initialize.hpp">initialize.hpp</a>, we try most 100 random initial points, until a point where log probability and its gradient can be evaluated successfully. In our case the first try is successful. Therefore we can now think that we exist somewhere in the (unconstrained) parameter space, at a point stored in <code>cont_vector</code>. The next step is to call</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>  util<span class="op">::</span>run_adaptive_sampler<span class="op">(</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>      sampler<span class="op">,</span> model<span class="op">,</span> cont_vector<span class="op">,</span> num_warmup<span class="op">,</span> num_samples<span class="op">,</span> num_thin<span class="op">,</span> refresh<span class="op">,</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>      save_warmup<span class="op">,</span> rng<span class="op">,</span> interrupt<span class="op">,</span> logger<span class="op">,</span> sample_writer<span class="op">,</span> diagnostic_writer<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which we will look at next.</p>
</section>
<section id="run_adaptive_sampler.hpp" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="run_adaptive_sampler.hpp"><span class="header-section-number">4.2</span> run_adaptive_sampler.hpp</h2>
<p>So we are now at <a href="https://github.com/stan-dev/stan/blob/develop/src/stan/services/util/run_adaptive_sampler.hpp">run_adaptive_sampler.hpp</a> which is in <strong>services/util</strong>. There we have three interesting parts.</p>
<ul>
<li><ol type="1">
<li>Initializing stepsize</li>
</ol></li>
<li><ol start="2" type="1">
<li>Generating transitions, adaptation engaged (warmup)</li>
</ol></li>
<li><ol start="3" type="1">
<li>Generating transitions, adaptation disengaged (sampling)</li>
</ol></li>
</ul>
<p>The part</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>sampler<span class="op">.</span>init_stepsize<span class="op">(</span>logger<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>initializes the stepsize and is defined in <a href="https://github.com/stan-dev/stan/blob/develop/src/stan/mcmc/hmc/base_hmc.hpp">mcmc/hmc/base_hmc.hpp</a>. This already involves a bit of Hamiltonian computations and evolving the Leapfrog integrator. After this, we start to actually generate MCMC transitions using the sampler. This is done in two phases with calls to</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>  util<span class="op">::</span>generate_transitions<span class="op">();</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and in the first one we have adaptation engaged. We will look at <code>generate_transitions()</code> in the next blog post. Spoiler alert: <code>sampler.init_stepsize()</code> will be called there again so we will also look at it more.</p>
</section>
</section>
<section id="resources" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Resources</h1>
<p>I have forks of CmdStan and Stan that print more verbose information about the program status than normally.</p>
<ul>
<li><a href="https://github.com/jtimonen/cmdstan/tree/understanding_stan_cpp">CmdStan</a></li>
<li><a href="https://github.com/jtimonen/stan/tree/understanding_stan_cpp">Stan</a></li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/jtimonen\.github\.io");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>