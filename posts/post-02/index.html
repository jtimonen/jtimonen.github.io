<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Juho Timonen">
<meta name="dcterms.date" content="2022-01-14">
<meta name="description" content="Studying the C++ code of the NUTS algorithm of Stan.">

<title>Understanding the Stan codebase - Part 2: Samplers – Juho Timonen</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../images/icon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-a185852c63625fd9ffbdc57047c9a77e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-10bd3313725fc881f5be1f841596b172.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Juho Timonen</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publications.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../software.html"> 
<span class="menu-text">Software</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> 
<span class="menu-text">Hobby projects</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a>
  <ul class="collapse">
  <li><a href="#recap-of-part-1" id="toc-recap-of-part-1" class="nav-link" data-scroll-target="#recap-of-part-1"><span class="header-section-number">1.1</span> Recap of Part 1</a></li>
  <li><a href="#starting-point-for-part-2" id="toc-starting-point-for-part-2" class="nav-link" data-scroll-target="#starting-point-for-part-2"><span class="header-section-number">1.2</span> Starting point for Part 2</a></li>
  </ul></li>
  <li><a href="#samplers" id="toc-samplers" class="nav-link" data-scroll-target="#samplers"><span class="header-section-number">2</span> Samplers</a>
  <ul class="collapse">
  <li><a href="#base_mcmc" id="toc-base_mcmc" class="nav-link" data-scroll-target="#base_mcmc"><span class="header-section-number">2.1</span> base_mcmc</a></li>
  <li><a href="#base_hmc" id="toc-base_hmc" class="nav-link" data-scroll-target="#base_hmc"><span class="header-section-number">2.2</span> base_hmc</a>
  <ul class="collapse">
  <li><a href="#class-attributes" id="toc-class-attributes" class="nav-link" data-scroll-target="#class-attributes"><span class="header-section-number">2.2.1</span> class attributes</a></li>
  <li><a href="#getters" id="toc-getters" class="nav-link" data-scroll-target="#getters"><span class="header-section-number">2.2.2</span> getters</a></li>
  <li><a href="#init_stepsize" id="toc-init_stepsize" class="nav-link" data-scroll-target="#init_stepsize"><span class="header-section-number">2.2.3</span> init_stepsize()</a></li>
  </ul></li>
  <li><a href="#base_nuts" id="toc-base_nuts" class="nav-link" data-scroll-target="#base_nuts"><span class="header-section-number">2.3</span> base_nuts</a></li>
  <li><a href="#diag_e_nuts" id="toc-diag_e_nuts" class="nav-link" data-scroll-target="#diag_e_nuts"><span class="header-section-number">2.4</span> diag_e_nuts</a></li>
  <li><a href="#adapt_diag_e_nuts" id="toc-adapt_diag_e_nuts" class="nav-link" data-scroll-target="#adapt_diag_e_nuts"><span class="header-section-number">2.5</span> adapt_diag_e_nuts</a></li>
  </ul></li>
  <li><a href="#adaptation" id="toc-adaptation" class="nav-link" data-scroll-target="#adaptation"><span class="header-section-number">3</span> Adaptation</a>
  <ul class="collapse">
  <li><a href="#class-hierarchy" id="toc-class-hierarchy" class="nav-link" data-scroll-target="#class-hierarchy"><span class="header-section-number">3.1</span> Class hierarchy</a></li>
  <li><a href="#algorithms" id="toc-algorithms" class="nav-link" data-scroll-target="#algorithms"><span class="header-section-number">3.2</span> Algorithms</a>
  <ul class="collapse">
  <li><a href="#learn_stepsize" id="toc-learn_stepsize" class="nav-link" data-scroll-target="#learn_stepsize"><span class="header-section-number">3.2.1</span> learn_stepsize()</a></li>
  <li><a href="#learn_variance" id="toc-learn_variance" class="nav-link" data-scroll-target="#learn_variance"><span class="header-section-number">3.2.2</span> learn_variance()</a></li>
  <li><a href="#update" id="toc-update" class="nav-link" data-scroll-target="#update"><span class="header-section-number">3.2.3</span> update</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">4</span> Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Understanding the Stan codebase - Part 2: Samplers</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Stan</div>
    <div class="quarto-category">C++</div>
  </div>
  </div>

<div>
  <div class="description">
    Studying the C++ code of the NUTS algorithm of Stan.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Juho Timonen </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 14, 2022</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<section id="recap-of-part-1" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="recap-of-part-1"><span class="header-section-number">1.1</span> Recap of Part 1</h2>
<p>We pick up from where we left off in <a href="https://jtimonen.github.io/posts/post-01/">Part 1</a>. We found out that CmdStan calls the Stan services in <code>cmdstan::command()</code>. For example with the command-line call</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mymodel.exe</span> id=1 method=sample algorithm=hmc engine=nuts adapt engaged=1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol type="1">
<li>the called service is <code>stan::services::sample::hmc_nuts_diag_adapt()</code></li>
<li>which then calls <code>stan::services::util::run_adaptive_sampler()</code></li>
<li>which calls <code>stan::services::util::generate_transitions()</code>.</li>
</ol>
<p>Note: All code pieces shown from now on in this post are adapted from <a href="https://github.com/stan-dev/stan">the stan source code</a>, licenced under the new BSD licence. Comments starting with <code>...</code> indicate parts that have been left out from original source code. During writing of this post, the most recent Stan version is 2.28.2. The hyperlinks to source code cannot be guaranteed to work in the future, if the source repo organization is changed or files are renamed.</p>
</section>
<section id="starting-point-for-part-2" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="starting-point-for-part-2"><span class="header-section-number">1.2</span> Starting point for Part 2</h2>
<p>We find <code>generate_transitions()</code> in <a href="https://github.com/stan-dev/stan/blob/develop/src/stan/services/util/generate_transitions.hpp">generate_transitions.hpp</a>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> generate_transitions<span class="op">(</span>stan<span class="op">::</span>mcmc<span class="op">::</span>base_mcmc<span class="op">&amp;</span> sampler<span class="op">,</span> <span class="dt">int</span> num_iterations<span class="op">,</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                          <span class="op">...,</span> stan<span class="op">::</span>mcmc<span class="op">::</span>sample<span class="op">&amp;</span> init_s<span class="op">,</span> Model<span class="op">&amp;</span> model<span class="op">,</span> <span class="op">...)</span> <span class="op">{</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> m <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> m <span class="op">&lt;</span> num_iterations<span class="op">;</span> <span class="op">++</span>m<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ... callbacks and progress printing</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    init_s <span class="op">=</span> sampler<span class="op">.</span>transition<span class="op">(</span>init_s<span class="op">,</span> logger<span class="op">);</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ... writing to output</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Among other things, it takes as input the sampler, model, and initial point in parameter space. The function is basically just a loop that calls <code>sampler.transition()</code> repeatedly for <code>num_iterations</code> times. Therefore, all interesting algorithmic code and properties that define how sampling works, whether adaptation is performed etc, have to be included as part of <code>sampler</code>.</p>
<p>This is why we now jump from the <code>stan::services</code> namespace to <code>stan::mcmc</code>, where the different samplers and their transitions are defined.</p>
</section>
</section>
<section id="samplers" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Samplers</h1>
<p>We see in <code>generate_transitions()</code> that <code>sampler</code> has to have type <code>base_mcmc</code>. However, in <code>stan::services::sample::hmc_nuts_diag_e_adapt()</code>, our sampler was declared as</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>stan<span class="op">::</span>mcmc<span class="op">::</span>adapt_diag_e_nuts<span class="op">&lt;</span>Model<span class="op">,</span> <span class="ex">boost::</span>ecuyer1988<span class="op">&gt;</span> sampler<span class="op">(</span>model<span class="op">,</span> rng<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>so what is going on?</p>
<center>
<img src="sampler_class_inheritance.png" alt="Sampler Classes" width="790">
</center>
<p>It appears that <code>adapt_diag_e_nuts</code> is a (templated) class that <a href="https://en.cppreference.com/w/cpp/language/derived_class">derives</a> from <code>base_mcmc</code> through multiple levels of inheritance, as can be seen from the above diagram.</p>
<section id="base_mcmc" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="base_mcmc"><span class="header-section-number">2.1</span> base_mcmc</h2>
<p>This is just an <a href="https://en.cppreference.com/w/cpp/language/abstract_class">interface</a> for all MCMC samplers, as it doesn’t contain any function bodies.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> base_mcmc <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a> <span class="kw">public</span><span class="op">:</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  base_mcmc<span class="op">()</span> <span class="op">{}</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">virtual</span> <span class="op">~</span>base_mcmc<span class="op">()</span> <span class="op">{}</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">virtual</span> sample transition<span class="op">(</span>sample<span class="op">&amp;</span> init_sample<span class="op">,</span> callbacks<span class="op">::</span>logger<span class="op">&amp;</span> logger<span class="op">)</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">virtual</span> <span class="dt">void</span> get_sampler_param_names<span class="op">(</span><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;&amp;</span> names<span class="op">)</span> <span class="op">{}</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">virtual</span> <span class="dt">void</span> get_sampler_params<span class="op">(</span><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> values<span class="op">)</span> <span class="op">{}</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">//... other virtual functions without body</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The class member functions are all <em>virtual</em> (except the constructor), meaning that deriving classes can override them. We see that <code>transition()</code> is <em>pure virtual</em> (declared with = 0), meaning that a deriving class <em>must</em> override it in order to be instantiable.</p>
</section>
<section id="base_hmc" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="base_hmc"><span class="header-section-number">2.2</span> base_hmc</h2>
<p>This is a base for all Hamiltonian samplers, and derives from <code>base_mcmc</code>.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">class</span> Model<span class="op">,</span> <span class="kw">template</span> <span class="op">&lt;</span><span class="kw">class</span><span class="op">,</span> <span class="kw">class</span><span class="op">&gt;</span> <span class="kw">class</span> Hamiltonian<span class="op">,</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>          <span class="kw">template</span> <span class="op">&lt;</span><span class="kw">class</span><span class="op">&gt;</span> <span class="kw">class</span> Integrator<span class="op">,</span> <span class="kw">class</span> BaseRNG<span class="op">&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> base_hmc <span class="op">:</span> <span class="kw">public</span> base_mcmc <span class="op">{</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a> <span class="kw">public</span><span class="op">:</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  base_hmc<span class="op">(</span><span class="at">const</span> Model<span class="op">&amp;</span> model<span class="op">,</span> BaseRNG<span class="op">&amp;</span> rng<span class="op">)</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>      <span class="op">:</span> base_mcmc<span class="op">(),</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">z_</span><span class="op">(</span>model<span class="op">.</span>num_params_r<span class="op">()),</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">integrator_</span><span class="op">(),</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">hamiltonian_</span><span class="op">(</span>model<span class="op">),</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">rand_int_</span><span class="op">(</span>rng<span class="op">),</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">rand_uniform_</span><span class="op">(</span><span class="va">rand_int_</span><span class="op">),</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">nom_epsilon_</span><span class="op">(</span><span class="fl">0.1</span><span class="op">),</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">epsilon_</span><span class="op">(</span><span class="va">nom_epsilon_</span><span class="op">),</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">epsilon_jitter_</span><span class="op">(</span><span class="fl">0.0</span><span class="op">)</span> <span class="op">{}</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> seed<span class="op">(</span><span class="at">const</span> Eigen<span class="op">::</span>VectorXd<span class="op">&amp;</span> q<span class="op">)</span> <span class="op">{</span> <span class="va">z_</span><span class="op">.</span>q <span class="op">=</span> q<span class="op">;</span> <span class="op">}</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> init_hamiltonian<span class="op">(</span>callbacks<span class="op">::</span>logger<span class="op">&amp;</span> logger<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">-&gt;</span><span class="va">hamiltonian_</span><span class="op">.</span>init<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">,</span> logger<span class="op">);</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> init_stepsize<span class="op">(</span>callbacks<span class="op">::</span>logger<span class="op">&amp;</span> logger<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    ps_point z_init<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">);</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Skip initialization for extreme step sizes</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span> <span class="op">==</span> <span class="dv">0</span> <span class="op">||</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span> <span class="op">&gt;</span> <span class="fl">1e7</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">||</span> <span class="bu">std::</span>isnan<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span><span class="op">))</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">-&gt;</span><span class="va">hamiltonian_</span><span class="op">.</span>sample_p<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">,</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">rand_int_</span><span class="op">);</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">-&gt;</span><span class="va">hamiltonian_</span><span class="op">.</span>init<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">,</span> logger<span class="op">);</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Guaranteed to be finite if randomly initialized</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> H0 <span class="op">=</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">hamiltonian_</span><span class="op">.</span>H<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">);</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">-&gt;</span><span class="va">integrator_</span><span class="op">.</span>evolve<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">,</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">hamiltonian_</span><span class="op">,</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span><span class="op">,</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>                             logger<span class="op">);</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> h <span class="op">=</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">hamiltonian_</span><span class="op">.</span>H<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">);</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="bu">std::</span>isnan<span class="op">(</span>h<span class="op">))</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>      h <span class="op">=</span> <span class="bu">std::</span>numeric_limits<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;::</span>infinity<span class="op">();</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> delta_H <span class="op">=</span> H0 <span class="op">-</span> h<span class="op">;</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> direction <span class="op">=</span> delta_H <span class="op">&gt;</span> <span class="bu">std::</span>log<span class="op">(</span><span class="fl">0.8</span><span class="op">)</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">.</span>ps_point<span class="op">::</span><span class="kw">operator</span><span class="op">=(</span>z_init<span class="op">);</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">-&gt;</span><span class="va">hamiltonian_</span><span class="op">.</span>sample_p<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">,</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">rand_int_</span><span class="op">);</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">-&gt;</span><span class="va">hamiltonian_</span><span class="op">.</span>init<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">,</span> logger<span class="op">);</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>      <span class="dt">double</span> H0 <span class="op">=</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">hamiltonian_</span><span class="op">.</span>H<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">);</span></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">-&gt;</span><span class="va">integrator_</span><span class="op">.</span>evolve<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">,</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">hamiltonian_</span><span class="op">,</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span><span class="op">,</span></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>                               logger<span class="op">);</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>      <span class="dt">double</span> h <span class="op">=</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">hamiltonian_</span><span class="op">.</span>H<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">);</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span><span class="bu">std::</span>isnan<span class="op">(</span>h<span class="op">))</span></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>        h <span class="op">=</span> <span class="bu">std::</span>numeric_limits<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;::</span>infinity<span class="op">();</span></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>      <span class="dt">double</span> delta_H <span class="op">=</span> H0 <span class="op">-</span> h<span class="op">;</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">((</span>direction <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!(</span>delta_H <span class="op">&gt;</span> <span class="bu">std::</span>log<span class="op">(</span><span class="fl">0.8</span><span class="op">)))</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> <span class="op">((</span>direction <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!(</span>delta_H <span class="op">&lt;</span> <span class="bu">std::</span>log<span class="op">(</span><span class="fl">0.8</span><span class="op">)))</span></span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span> <span class="op">=</span> direction <span class="op">==</span> <span class="dv">1</span> <span class="op">?</span> <span class="fl">2.0</span> <span class="op">*</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>                                            <span class="op">:</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span><span class="op">;</span></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span> <span class="op">&gt;</span> <span class="fl">1e7</span><span class="op">)</span></span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Posterior is improper. "</span></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Please check your model."</span><span class="op">);</span></span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>            <span class="st">"No acceptably small step size could "</span></span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>            <span class="st">"be found. Perhaps the posterior is "</span></span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>            <span class="st">"not continuous?"</span><span class="op">);</span></span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">.</span>ps_point<span class="op">::</span><span class="kw">operator</span><span class="op">=(</span>z_init<span class="op">);</span></span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>  <span class="kw">typename</span> Hamiltonian<span class="op">&lt;</span>Model<span class="op">,</span> BaseRNG<span class="op">&gt;::</span>PointType<span class="op">&amp;</span> z<span class="op">()</span> <span class="op">{</span> <span class="cf">return</span> <span class="va">z_</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="kw">typename</span> Hamiltonian<span class="op">&lt;</span>Model<span class="op">,</span> BaseRNG<span class="op">&gt;::</span>PointType<span class="op">&amp;</span> z<span class="op">()</span> <span class="at">const</span> <span class="kw">noexcept</span> <span class="op">{</span></span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">z_</span><span class="op">;</span></span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ... setters and getters for the protected properties</span></span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> sample_stepsize<span class="op">()</span> <span class="op">{</span></span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">-&gt;</span><span class="va">epsilon_</span> <span class="op">=</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span><span class="op">;</span></span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">epsilon_jitter_</span><span class="op">)</span></span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">-&gt;</span><span class="va">epsilon_</span></span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>          <span class="op">*=</span> <span class="fl">1.0</span> <span class="op">+</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">epsilon_jitter_</span> <span class="op">*</span> <span class="op">(</span><span class="fl">2.0</span> <span class="op">*</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">rand_uniform_</span><span class="op">()</span> <span class="op">-</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a> <span class="kw">protected</span><span class="op">:</span></span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>  <span class="kw">typename</span> Hamiltonian<span class="op">&lt;</span>Model<span class="op">,</span> BaseRNG<span class="op">&gt;::</span>PointType <span class="va">z_</span><span class="op">;</span></span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>  Integrator<span class="op">&lt;</span>Hamiltonian<span class="op">&lt;</span>Model<span class="op">,</span> BaseRNG<span class="op">&gt;</span> <span class="op">&gt;</span> <span class="va">integrator_</span><span class="op">;</span></span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>  Hamiltonian<span class="op">&lt;</span>Model<span class="op">,</span> BaseRNG<span class="op">&gt;</span> <span class="va">hamiltonian_</span><span class="op">;</span></span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>  BaseRNG<span class="op">&amp;</span> <span class="va">rand_int_</span><span class="op">;</span></span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Uniform(0, 1) RNG</span></span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>  <span class="ex">boost::</span>uniform_01<span class="op">&lt;</span>BaseRNG<span class="op">&amp;&gt;</span> <span class="va">rand_uniform_</span><span class="op">;</span></span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> <span class="va">nom_epsilon_</span><span class="op">;</span></span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> <span class="va">epsilon_</span><span class="op">;</span></span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> <span class="va">epsilon_jitter_</span><span class="op">;</span></span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We see that the class doesn’t implement <code>transition()</code>, so it is also an abstract class. What it does do is it defines some attributes that all Hamiltonian samplers need.</p>
<section id="class-attributes" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="class-attributes"><span class="header-section-number">2.2.1</span> class attributes</h3>
<p>The attributes listed as protected describe the internal state of the sampler. All Hamiltonian samplers have these attributes, and the most interesting ones of them are</p>
<ul>
<li><code>z_</code>: current state of the sampler (point in parameter space)</li>
<li><code>integrator_</code>: numerical integrator used to simulate the Hamiltonian dynamics</li>
<li><code>hamiltonian_</code>: the Hamiltonian system</li>
<li><code>epsilon_</code> / <code>nom_epsilon_</code>: step size of the integrator</li>
</ul>
</section>
<section id="getters" class="level3" data-number="2.2.2">
<h3 data-number="2.2.2" class="anchored" data-anchor-id="getters"><span class="header-section-number">2.2.2</span> getters</h3>
<p>The above are private attributes and should not be directly <a href="https://en.cppreference.com/w/cpp/language/access">accessed</a> from the outside. Instead, there are some getter methods that can be used, for example</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">typename</span> Hamiltonian<span class="op">&lt;</span>Model<span class="op">,</span> BaseRNG<span class="op">&gt;::</span>PointType<span class="op">&amp;</span> z<span class="op">()</span> <span class="op">{</span> <span class="cf">return</span> <span class="va">z_</span><span class="op">;</span> <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>so one could use <code>sampler.z()</code> to get the current point in the (unconstrained) parameter space.</p>
</section>
<section id="init_stepsize" class="level3" data-number="2.2.3">
<h3 data-number="2.2.3" class="anchored" data-anchor-id="init_stepsize"><span class="header-section-number">2.2.3</span> init_stepsize()</h3>
<p>The first actual algorithm that we encouter is the <code>init_stepsize()</code> method of the <code>base_hmc</code> class, defined in <a href="https://github.com/stan-dev/stan/blob/develop/src/stan/mcmc/hmc/base_hmc.hpp">base_hmc.hpp</a>. This defines how the integrator’s initial stepsize (possibly given by user) is refined. As we saw in Part 1, this gets called in <code>stan::services::sample::hmc_nuts_diag_e_adapt()</code> before any MCMC iterations are done.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> init_stepsize<span class="op">(</span>callbacks<span class="op">::</span>logger<span class="op">&amp;</span> logger<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    ps_point z_init<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">);</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Skip initialization for extreme step sizes</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span> <span class="op">==</span> <span class="dv">0</span> <span class="op">||</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span> <span class="op">&gt;</span> <span class="fl">1e7</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">||</span> <span class="bu">std::</span>isnan<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span><span class="op">))</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">-&gt;</span><span class="va">hamiltonian_</span><span class="op">.</span>sample_p<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">,</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">rand_int_</span><span class="op">);</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">-&gt;</span><span class="va">hamiltonian_</span><span class="op">.</span>init<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">,</span> logger<span class="op">);</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Guaranteed to be finite if randomly initialized</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> H0 <span class="op">=</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">hamiltonian_</span><span class="op">.</span>H<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">);</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">-&gt;</span><span class="va">integrator_</span><span class="op">.</span>evolve<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">,</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">hamiltonian_</span><span class="op">,</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span><span class="op">,</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>                             logger<span class="op">);</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> h <span class="op">=</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">hamiltonian_</span><span class="op">.</span>H<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">);</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="bu">std::</span>isnan<span class="op">(</span>h<span class="op">))</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>      h <span class="op">=</span> <span class="bu">std::</span>numeric_limits<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;::</span>infinity<span class="op">();</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> delta_H <span class="op">=</span> H0 <span class="op">-</span> h<span class="op">;</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> direction <span class="op">=</span> delta_H <span class="op">&gt;</span> <span class="bu">std::</span>log<span class="op">(</span><span class="fl">0.8</span><span class="op">)</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">.</span>ps_point<span class="op">::</span><span class="kw">operator</span><span class="op">=(</span>z_init<span class="op">);</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">-&gt;</span><span class="va">hamiltonian_</span><span class="op">.</span>sample_p<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">,</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">rand_int_</span><span class="op">);</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">-&gt;</span><span class="va">hamiltonian_</span><span class="op">.</span>init<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">,</span> logger<span class="op">);</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>      <span class="dt">double</span> H0 <span class="op">=</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">hamiltonian_</span><span class="op">.</span>H<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">);</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">-&gt;</span><span class="va">integrator_</span><span class="op">.</span>evolve<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">,</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">hamiltonian_</span><span class="op">,</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span><span class="op">,</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>                               logger<span class="op">);</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>      <span class="dt">double</span> h <span class="op">=</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">hamiltonian_</span><span class="op">.</span>H<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">);</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span><span class="bu">std::</span>isnan<span class="op">(</span>h<span class="op">))</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>        h <span class="op">=</span> <span class="bu">std::</span>numeric_limits<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;::</span>infinity<span class="op">();</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>      <span class="dt">double</span> delta_H <span class="op">=</span> H0 <span class="op">-</span> h<span class="op">;</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">((</span>direction <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!(</span>delta_H <span class="op">&gt;</span> <span class="bu">std::</span>log<span class="op">(</span><span class="fl">0.8</span><span class="op">)))</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> <span class="op">((</span>direction <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!(</span>delta_H <span class="op">&lt;</span> <span class="bu">std::</span>log<span class="op">(</span><span class="fl">0.8</span><span class="op">)))</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span> <span class="op">=</span> direction <span class="op">==</span> <span class="dv">1</span> <span class="op">?</span> <span class="fl">2.0</span> <span class="op">*</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>                                            <span class="op">:</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span><span class="op">;</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span> <span class="op">&gt;</span> <span class="fl">1e7</span><span class="op">)</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Posterior is improper. "</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Please check your model."</span><span class="op">);</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>            <span class="st">"No acceptably small step size could "</span></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>            <span class="st">"be found. Perhaps the posterior is "</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>            <span class="st">"not continuous?"</span><span class="op">);</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">.</span>ps_point<span class="op">::</span><span class="kw">operator</span><span class="op">=(</span>z_init<span class="op">);</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>On the lines</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> H0 <span class="op">=</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">hamiltonian_</span><span class="op">.</span>H<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">);</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">-&gt;</span><span class="va">integrator_</span><span class="op">.</span>evolve<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">,</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">hamiltonian_</span><span class="op">,</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span><span class="op">,</span>logger<span class="op">);</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> h <span class="op">=</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">hamiltonian_</span><span class="op">.</span>H<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">);</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> delta_H <span class="op">=</span> H0 <span class="op">-</span> h<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>the Hamiltonian is first computed at the current point <code>z_</code>, then the integrator evolves the state, after which the Hamiltonian is computed at the new state. The change in Hamiltonian (<code>delta_H</code>) then determines how the nominal stepsize (<code>nom_epsilon_</code>) is refined, or if it is suitable so that the actual MCMC sampling can start.</p>
</section>
</section>
<section id="base_nuts" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="base_nuts"><span class="header-section-number">2.3</span> base_nuts</h2>
<p>This is defined in <a href="https://github.com/stan-dev/stan/blob/develop/src/stan/mcmc/hmc/nuts/base_nuts.hpp">base_nuts.hpp</a>, and is the base class for No-U-Turn samplers with multinomial sampling. This class, which derives from <code>base_hmc</code>, is the first place where we encounter an implementation of <code>transition()</code>. You can read the comments in the source code of the <code>transition()</code> method to get and idea of the progress of the algorithm. We won’t go into details of the NUTS algorithm here, but just notice that the <code>transition()</code> function takes as input a <code>sample&amp; init_sample</code> and generates a new <code>sample</code> object and returns it. Here, sample is a class that describes one MCMC draw, and it is defined in <a href="https://github.com/stan-dev/stan/blob/develop/src/stan/mcmc/sample.hpp">sample.hpp</a>.</p>
</section>
<section id="diag_e_nuts" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="diag_e_nuts"><span class="header-section-number">2.4</span> diag_e_nuts</h2>
<p>This is a base class for NUTS with the diagonal HMC metric (diagonal mass matrix), and derives from <code>base_nuts</code>. There are similar classes for the dense and unit metric too. There are no new methods here.</p>
</section>
<section id="adapt_diag_e_nuts" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="adapt_diag_e_nuts"><span class="header-section-number">2.5</span> adapt_diag_e_nuts</h2>
<p>Finally we get to the class the defines the adaptive NUTS sampler with the diagonal metric. This class, <code>adapt_diag_e_nuts</code>, derives from <code>diag_e_nuts</code>. It overrides the <code>transition()</code> method with</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>sample transition<span class="op">(</span>sample<span class="op">&amp;</span> init_sample<span class="op">,</span> callbacks<span class="op">::</span>logger<span class="op">&amp;</span> logger<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    sample s <span class="op">=</span> diag_e_nuts<span class="op">&lt;</span>Model<span class="op">,</span> BaseRNG<span class="op">&gt;::</span>transition<span class="op">(</span>init_sample<span class="op">,</span> logger<span class="op">);</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">adapt_flag_</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">-&gt;</span><span class="va">stepsize_adaptation_</span><span class="op">.</span>learn_stepsize<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span><span class="op">,</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>                                                s<span class="op">.</span>accept_stat<span class="op">());</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">bool</span> update <span class="op">=</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">var_adaptation_</span><span class="op">.</span>learn_variance<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">.</span><span class="va">inv_e_metric_</span><span class="op">,</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>                                                         <span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">.</span>q<span class="op">);</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>update<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">-&gt;</span>init_stepsize<span class="op">(</span>logger<span class="op">);</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">-&gt;</span><span class="va">stepsize_adaptation_</span><span class="op">.</span>set_mu<span class="op">(</span>log<span class="op">(</span><span class="dv">10</span> <span class="op">*</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span><span class="op">));</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">-&gt;</span><span class="va">stepsize_adaptation_</span><span class="op">.</span>restart<span class="op">();</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> s<span class="op">;</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The actual transition</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>sample s <span class="op">=</span> diag_e_nuts<span class="op">&lt;</span>Model<span class="op">,</span> BaseRNG<span class="op">&gt;::</span>transition<span class="op">(</span>init_sample<span class="op">,</span> logger<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>is still performed by calling the implementation of the parent class. This is the implementation defined in <code>base_nuts</code>, because <code>diag_e_nuts</code> does not override it. The other code is for adapting the HMC metric and the integrator step size. To study how this work, we need to find out what <code>stepsize_adaptation_</code> and <code>var_adaptation_</code> are. However, we can’t seem to find them in <code>adapt_diag_e_nuts.hpp</code>. So what is again going on?</p>
</section>
</section>
<section id="adaptation" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Adaptation</h1>
<p>We find that in addition to <code>diag_e_nuts</code>, the <code>adapt_diag_e_nuts</code> class derives also from another class, called <code>stepsize_var_adapter</code> (defined in <a href="https://github.com/stan-dev/stan/blob/develop/src/stan/mcmc/stepsize_var_adapter.hpp">stepsize_var_adapter.hpp</a>).</p>
<section id="class-hierarchy" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="class-hierarchy"><span class="header-section-number">3.1</span> Class hierarchy</h2>
<center>
<img src="adaptation.png" alt="Adaptation Classes" width="490">
</center>
<p>The above diagram explains why sampler objects of class <code>adapt_diag_e_nuts</code> have the <code>stepsize_adaptation_</code> and <code>var_adaptation_ attributes</code>. The former is for adapting the integrator step size and the latter for adapting the mass matrix diagonal. The metric is adapted in three <a href="https://github.com/stan-dev/stan/blob/develop/src/stan/mcmc/windowed_adaptation.hpp">windows</a>, which are called <em>init_buffer</em>, <em>term_buffer</em> and <em>base_window</em>. The the most abstract base class is <a href="https://github.com/stan-dev/stan/blob/develop/src/stan/mcmc/base_adaptation.hpp">base_adaptation</a>, which doesn’t contain any implemented methods.</p>
</section>
<section id="algorithms" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="algorithms"><span class="header-section-number">3.2</span> Algorithms</h2>
<p>Let’s now return to studying the <code>transition()</code> method of the <code>adapt_diag_e_nuts</code> class. When the <code>adapt_flag_</code> is on (that is, in the warmup phase), each transition will run the code</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">-&gt;</span><span class="va">stepsize_adaptation_</span><span class="op">.</span>learn_stepsize<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span><span class="op">,</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                                                s<span class="op">.</span>accept_stat<span class="op">());</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> update <span class="op">=</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">var_adaptation_</span><span class="op">.</span>learn_variance<span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">.</span><span class="va">inv_e_metric_</span><span class="op">,</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                                                         <span class="kw">this</span><span class="op">-&gt;</span><span class="va">z_</span><span class="op">.</span>q<span class="op">);</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>update<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">-&gt;</span>init_stepsize<span class="op">(</span>logger<span class="op">);</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">-&gt;</span><span class="va">stepsize_adaptation_</span><span class="op">.</span>set_mu<span class="op">(</span>log<span class="op">(</span><span class="dv">10</span> <span class="op">*</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span><span class="op">));</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">-&gt;</span><span class="va">stepsize_adaptation_</span><span class="op">.</span>restart<span class="op">();</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="learn_stepsize" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="learn_stepsize"><span class="header-section-number">3.2.1</span> learn_stepsize()</h3>
<p>The <code>learn_stepsize()</code> algorithm is defined in <code>stepsize_adaptation.hpp</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> learn_stepsize<span class="op">(</span><span class="dt">double</span><span class="op">&amp;</span> epsilon<span class="op">,</span> <span class="dt">double</span> adapt_stat<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">++</span><span class="va">counter_</span><span class="op">;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    adapt_stat <span class="op">=</span> adapt_stat <span class="op">&gt;</span> <span class="dv">1</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> adapt_stat<span class="op">;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Nesterov Dual-Averaging of log(epsilon)</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span> eta <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="op">(</span><span class="va">counter_</span> <span class="op">+</span> <span class="va">t0_</span><span class="op">);</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="va">s_bar_</span> <span class="op">=</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">-</span> eta<span class="op">)</span> <span class="op">*</span> <span class="va">s_bar_</span> <span class="op">+</span> eta <span class="op">*</span> <span class="op">(</span><span class="va">delta_</span> <span class="op">-</span> adapt_stat<span class="op">);</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span> x <span class="op">=</span> <span class="va">mu_</span> <span class="op">-</span> <span class="va">s_bar_</span> <span class="op">*</span> <span class="bu">std::</span>sqrt<span class="op">(</span><span class="va">counter_</span><span class="op">)</span> <span class="op">/</span> <span class="va">gamma_</span><span class="op">;</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span> x_eta <span class="op">=</span> <span class="bu">std::</span>pow<span class="op">(</span><span class="va">counter_</span><span class="op">,</span> <span class="op">-</span><span class="va">kappa_</span><span class="op">);</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="va">x_bar_</span> <span class="op">=</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">-</span> x_eta<span class="op">)</span> <span class="op">*</span> <span class="va">x_bar_</span> <span class="op">+</span> x_eta <span class="op">*</span> x<span class="op">;</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    epsilon <span class="op">=</span> <span class="bu">std::</span>exp<span class="op">(</span>x<span class="op">);</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="learn_variance" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="learn_variance"><span class="header-section-number">3.2.2</span> learn_variance()</h3>
<p>The <code>learn_variance()</code> algorithm on the other hand is defined in <a href="https://github.com/stan-dev/stan/blob/develop/src/stan/mcmc/var_adaptation.hpp">var_adaptation.hpp</a></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> learn_variance<span class="op">(</span>Eigen<span class="op">::</span>VectorXd<span class="op">&amp;</span> var<span class="op">,</span> <span class="at">const</span> Eigen<span class="op">::</span>VectorXd<span class="op">&amp;</span> q<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>adaptation_window<span class="op">())</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>      <span class="va">estimator_</span><span class="op">.</span>add_sample<span class="op">(</span>q<span class="op">);</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>end_adaptation_window<span class="op">())</span> <span class="op">{</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>      compute_next_window<span class="op">();</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>      <span class="va">estimator_</span><span class="op">.</span>sample_variance<span class="op">(</span>var<span class="op">);</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">double</span> n <span class="op">=</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(</span><span class="va">estimator_</span><span class="op">.</span>num_samples<span class="op">());</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>      var <span class="op">=</span> <span class="op">(</span>n <span class="op">/</span> <span class="op">(</span>n <span class="op">+</span> <span class="fl">5.0</span><span class="op">))</span> <span class="op">*</span> var</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>            <span class="op">+</span> <span class="fl">1e-3</span> <span class="op">*</span> <span class="op">(</span><span class="fl">5.0</span> <span class="op">/</span> <span class="op">(</span>n <span class="op">+</span> <span class="fl">5.0</span><span class="op">))</span> <span class="op">*</span> Eigen<span class="op">::</span>VectorXd<span class="op">::</span>Ones<span class="op">(</span>var<span class="op">.</span>size<span class="op">());</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(!</span>var<span class="op">.</span>allFinite<span class="op">())</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(...);</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>      <span class="va">estimator_</span><span class="op">.</span>restart<span class="op">();</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>      <span class="op">++</span><span class="va">adapt_window_counter_</span><span class="op">;</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">++</span><span class="va">adapt_window_counter_</span><span class="op">;</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The interesting thing about this is that it returns <code>true</code> at the end of the three adaptation windows, and otherwise <code>false</code>. This return value (<code>update</code>) determines what happens at the end of the transition.</p>
</section>
<section id="update" class="level3" data-number="3.2.3">
<h3 data-number="3.2.3" class="anchored" data-anchor-id="update"><span class="header-section-number">3.2.3</span> update</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>update<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">-&gt;</span>init_stepsize<span class="op">(</span>logger<span class="op">);</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">-&gt;</span><span class="va">stepsize_adaptation_</span><span class="op">.</span>set_mu<span class="op">(</span>log<span class="op">(</span><span class="dv">10</span> <span class="op">*</span> <span class="kw">this</span><span class="op">-&gt;</span><span class="va">nom_epsilon_</span><span class="op">));</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">-&gt;</span><span class="va">stepsize_adaptation_</span><span class="op">.</span>restart<span class="op">();</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This part is again an interesting algorithmic detail of the adaptation. We see that at the end of each window of metric adaptation, the stepsize adaptation is restarted from 10 times the average stepsize from the previous window. See <a href="https://discourse.mc-stan.org/t/issue-with-dual-averaging/5995">this thread</a> for some motivation, discussion, and potential problems caused by this approach.</p>
</section>
</section>
</section>
<section id="conclusion" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Conclusion</h1>
<ul>
<li>In this post we looked at the hierarchy of sampler and adaptation classes in Stan. These are all part of the <code>stan::mcmc</code> namespace, and are needed by the services (<code>stan::services</code>).</li>
<li>The algorithmic details of a sampler are defined by its <code>transition</code>. We did not study the algorithms in detail, but mainly how the code is organized and where to find the implementations of the algorithms.</li>
<li>For HMC samplers, one part of the algorithm is always <code>init_stepsize()</code>, which initializes the stepsize of the leapfrog integrator before any MCMC transitions.</li>
<li>In this post, we did not go into the details of the <a href="https://github.com/stan-dev/stan/tree/develop/src/stan/mcmc/hmc/hamiltonians">Hamiltonians</a> and <a href="https://github.com/stan-dev/stan/tree/develop/src/stan/mcmc/hmc/integrators">integrators</a>. These have a key role in the NUTS transition, and the details can be studied in the linked source code.</li>
</ul>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/jtimonen\.github\.io");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>